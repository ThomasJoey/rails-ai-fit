
<% messages.each do |message| %>
  <% is_current_user = message.role == "user" %>

  <div class="chat-message d-flex mb-3 <%= is_current_user ? 'justify-content-end' : 'justify-content-start' %>">

    <% unless is_current_user %>
      <%= render "layouts/avatar",
          initials: "AI",
          image_url: nil, # ou une image fixe de ton assistant
          size: "sm",
          gradient: "gradient-blue-green",
          extra_classes: "me-2" %>
    <% end %>

    <div class="message-block">
      <div class="chat-bubble <%= is_current_user ? 'outgoing' : 'incoming' %>">
        <% if !is_current_user %>
          <% latest_assistant = message.conversation.messages.where(role: "assistant").order(:created_at).last %>
          <% if latest_assistant && latest_assistant.id == message.id %>
            <% window_start = message.created_at %>
            <% window_end   = message.created_at + 20.seconds %>
            <% recent_events = Event.where(user: current_user)
                                    .where(created_at: window_start..window_end)
                                    .order(:created_at)
                                    .limit(1) %>
            <% if recent_events.any? %>
              <% event = recent_events.first %>
              <div class="event-card">
                <h5><%= event.title %></h5>
                <p><%= event.description %></p>
                <p><strong>üìç</strong> <%= event.location %></p>
                <% if event.starts_at.present? %>
                  <p><strong>üïí</strong> <%= event.starts_at.strftime("%d/%m/%Y %H:%M") %></p>
                <% end %>
                <% if event.ends_at.present? %>
                  <p><strong>üèÅ</strong> <%= event.ends_at.strftime("%d/%m/%Y %H:%M") %></p>
                <% end %>
                <div class="mt-3">
                  <a class="btn plus-button w-100" href="#">Rejoindre l'activit√©</a>
                </div>
              </div>
            <% else %>
              <%= simple_format(h(message.content)) %>
            <% end %>
          <% else %>
            <%= simple_format(h(message.content)) %>
          <% end %>
        <% else %>
          <%= simple_format(h(message.content)) %>
        <% end %>
      </div>
      <div class="chat-time-below text-muted small mt-1 <%= is_current_user ? 'text-end' : 'text-start' %>">
        <%= l(message.created_at, format: :short) if message.respond_to?(:created_at) && message.created_at.present? %>
      </div>
    </div>
  </div>
<% end %>
